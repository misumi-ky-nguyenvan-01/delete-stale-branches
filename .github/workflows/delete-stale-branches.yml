name: Delete stale branches (Improved)
on:
  push:
    branches:
      - main
  workflow_dispatch:
jobs:
  delete-stale-branches:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo
            const cutoffDate = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000)
            
            const patterns = ['feature/', 'test/', 'release/', 'revert-']
            let totalDeleted = 0
            
            for (const pattern of patterns) {
              const query = `{
                repository(owner: "${owner}", name: "${repo}") {
                  refs(refPrefix: "refs/heads/${pattern}", first: 50) {
                    nodes {
                      name
                      target {
                        ... on Commit {
                          committedDate
                        }
                      }
                    }
                  }
                }
              }`
              
              const result = await github.graphql(query)
              const branches = result.repository.refs.nodes
              
              console.log(`Found ${branches.length} branches for pattern: ${pattern}`)
              
              for (const branch of branches) {
                const lastCommitDate = new Date(branch.target.committedDate)
                const daysSince = Math.floor((Date.now() - lastCommitDate.getTime()) / (1000 * 60 * 60 * 24))
                
                if (lastCommitDate < cutoffDate) {
                  try {
                    await github.rest.git.deleteRef({ owner, repo, ref: `heads/${branch.name}` })
                    console.log(`Deleted: ${branch.name} (${daysSince} days old)`)
                    totalDeleted++
                  } catch (error) {
                    console.log(`Failed to delete ${branch.name}: ${error.message}`)
                  }
                }
              }
            }
            
            console.log(`Total deleted: ${totalDeleted}`)
