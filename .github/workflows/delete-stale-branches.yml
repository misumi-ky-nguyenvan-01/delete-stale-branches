name: 古いブランチを自動削除

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'true の場合、実際にはブランチを削除しません（デフォルト: true）'
        required: false
        type: boolean
        default: true
      days_until_stale:
        description: '最終コミットからの経過日数（デフォルト: 90）'
        required: false
        type: number
        default: 90

jobs:
  delete-stale-branches:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read

    steps:
      - uses: actions/checkout@v5

      - uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo
            const { execSync } = require('child_process')

            // デフォルト値を設定（push イベントの場合は inputs が undefined になるため）
            const DAYS_UNTIL_STALE = parseInt('${{ inputs.days_until_stale }}') || 90
            const DRY_RUN = '${{ inputs.dry_run }}' === 'true'

            core.info(`設定値: DRY_RUN=${DRY_RUN}, DAYS_UNTIL_STALE=${DAYS_UNTIL_STALE}日`)

            const branchPatterns = [
              { prefix: 'feature/', requireMergedPR: true },
              { prefix: 'test/', requireMergedPR: false },
              { prefix: 'release/', requireMergedPR: false },
              { prefix: 'revert-', requireMergedPR: true }
            ]

            // 最も古いコミットを持つ100個ブランチを取得する
            async function fetchBranches() {
              try {
                const query = `
                  query($owner: String!, $repo: String!) {
                    repository(owner: $owner, name: $repo) {
                      refs(refPrefix: "refs/heads/", first: 100) {
                        nodes {
                          name
                          target {
                            ... on Commit { committedDate }
                          }
                        }
                      }
                    }
                  }
                `

                const { repository } = await github.graphql(query, { owner, repo })
                return repository.refs.nodes.map(({ name, target }) => ({
                  name,
                  lastCommitDate: new Date(target.committedDate),
                }))
              } catch (error) {
                core.setFailed(`ブランチ取得エラー: ${error}`)
                throw error
              }
            }

            // マージ済みPRが1つ以上存在し、オープンのPRが存在しない
            async function hasMergedPR(branchName) {
              try {
                const { data: pullRequests } = await github.rest.pulls.list({
                  owner,
                  repo,
                  head: `${owner}:${branchName}`,
                  state: 'all',
                })

                return (
                  pullRequests.length > 0 &&
                  pullRequests.some(({ merged_at }) => merged_at !== null) &&
                  pullRequests.every(({ state }) => state !== 'open')
                )
              } catch (error) {
                core.info(`PR確認エラー (${branchName}): ${error}`)
                return false
              }
            }

            // - 最終コミットからDAYS_UNTIL_STALE日以上経過している
            // - requireMergedPRブランチの場合、マージ済みPRがあること
            const isDeletable = async ({ name, lastCommitDate }) => {
              const daysSince = (Date.now() - lastCommitDate.getTime()) / (1000 * 60 * 60 * 24)
              if (daysSince < DAYS_UNTIL_STALE) return false

              const matchedPattern = branchPatterns.find(({ prefix }) => name.startsWith(prefix))
              if (!matchedPattern) return false

              return !matchedPattern.requireMergedPR || await hasMergedPR(name)
            }

            const branchesFetched = await fetchBranches()
            const branchesToDelete = (
              await Promise.all(branchesFetched.map(async (branch) => await isDeletable(branch) ? branch : null))
            ).filter(Boolean)

            if (branchesToDelete.length > 0 && !DRY_RUN) {
              try {
                const branchNames = branchesToDelete.map(({ name }) => name).join(' ')
                execSync(`git push origin --delete ${branchNames}`, { stdio: 'inherit' })
                core.info('✅ すべてのブランチの削除が完了しました')
              } catch (error) {
                core.setFailed(`❌ git push --delete でエラーが発生しました: ${error}`)
                throw error
              }
            }

            core.summary
              .addHeading(DRY_RUN ? '削除対象ブランチ（DRY-RUN）' : 'ブランチ削除結果')
              .addTable([
                [{ data: '項目', header: true }, { data: '詳細', header: true }],
                ['Stale判定条件', `${DAYS_UNTIL_STALE}日以上コミットがないもの`],
                ['取得ブランチ数', `${branchesFetched.length}`],
                ['削除ブランチ数', `${branchesToDelete.length}`],
            ])
            .addList(branchesToDelete.map(({ name, lastCommitDate }) => `${lastCommitDate.toLocaleDateString()}: ${name}`))
            .write()
