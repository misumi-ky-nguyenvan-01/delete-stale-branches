name: Delete stale branches (One Fetch)
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'true の場合、実際にはブランチを削除しません（デフォルト: true）'
        required: false
        default: 'true'
      max_deletions:
        description: '一度の実行で削除する最大ブランチ数（デフォルト: 50）'
        required: false
        default: '50'
      diff_or_date:
        description: '最終コミットからの経過日数（デフォルト: 90）'
        required: false
        default: '90'

jobs:
  delete-stale-branches:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Create logs directory
        run: mkdir -p .github/logs

      - uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo
            const { execSync } = require('child_process')
            const LOG_FILE_PATH = '.github/logs/deleted-branches.log'
            
            // デフォルト値を設定（push イベントの場合は inputs が undefined になるため）
            const DIFF_OR_DATE = parseInt('${{ inputs.diff_or_date }}' || '90')
            const MAX_DELETIONS = parseInt('${{ inputs.max_deletions }}' || '50')
            const DRY_RUN = ('${{ inputs.dry_run }}' || 'true') === 'true'

            console.log(`設定値: DRY_RUN=${DRY_RUN}, MAX_DELETIONS=${MAX_DELETIONS}, DIFF_OR_DATE=${DIFF_OR_DATE}日`)

            const branchPatterns = [
              { prefix: 'feature/', requireClosedPR: true },
              { prefix: 'test/', requireClosedPR: false },
              { prefix: 'release/', requireClosedPR: false },
              { prefix: 'revert-', requireClosedPR: true }
            ]

            function writeLog(message) {
              const timestamp = new Date().toISOString()
              const logEntry = `[${timestamp}] ${message}`
              execSync(`echo "${logEntry}" >> ${LOG_FILE_PATH}`)
            }

            async function fetchAllBranches() {
              let hasNextPage = true
              let endCursor = null
              let allBranches = []

              while (hasNextPage) {
                const query = `
                  query($owner: String!, $repo: String!, $cursor: String) {
                    repository(owner: $owner, name: $repo) {
                      refs(refPrefix: "refs/heads/", first: 100, after: $cursor) {
                        pageInfo {
                          hasNextPage
                          endCursor
                        }
                        nodes {
                          name
                          target {
                            ... on Commit { committedDate }
                          }
                        }
                      }
                    }
                  }
                `

                const result = await github.graphql(query, { owner, repo, cursor: endCursor })
                const refs = result.repository.refs
                const branches = refs.nodes

                const batch = branches.map(branch => ({
                  name: branch.name,
                  lastCommitDate: new Date(branch.target.committedDate)
                }))

                allBranches.push(...batch)

                hasNextPage = refs.pageInfo.hasNextPage
                endCursor = refs.pageInfo.endCursor
              }

              return allBranches
            }

            async function isDeletableBranch(branchName) {
              const { data: pullRequests } = await github.rest.pulls.list({
                owner,
                repo,
                head: `${owner}:${branchName}`,
                state: 'all'
              })
              if (pullRequests.length === 0) return true
              return pullRequests.every(pr => pr.state === 'closed' || pr.state === 'merged')
            }

            async function filterDeletableBranches(allBranches) {
              const branchesToDelete = []
              const patternStats = {}

              for (const pattern of branchPatterns) {
                patternStats[pattern.prefix] = 0
              }

              for (const branch of allBranches) {
                const matchedPattern = branchPatterns.find(pattern => 
                  branch.name.startsWith(pattern.prefix)
                )

                if (!matchedPattern) {
                  continue
                }

                patternStats[matchedPattern.prefix]++

                const daysSince = Math.floor((Date.now() - branch.lastCommitDate.getTime()) / (1000 * 60 * 60 * 24))
                if (daysSince < DIFF_OR_DATE) {
                  continue
                }

                let canDelete = true
                if (matchedPattern.requireClosedPR) {
                  canDelete = await isDeletableBranch(branch.name)
                }

                if (!canDelete) {
                  continue
                }

                branchesToDelete.push({
                  name: branch.name,
                  lastCommitDate: branch.lastCommitDate,
                  requireClosedPR: matchedPattern.requireClosedPR,
                  pattern: matchedPattern.prefix,
                  daysSince: daysSince
                })
              }

              return { branchesToDelete, patternStats }
            }

            let allBranches = []

            try {
              allBranches = await fetchAllBranches()
            } catch (error) {
              console.error(`ブランチの取得中にエラーが発生しました: ${error.message}`)
              process.exit(1)
            }

            console.log(`取得したブランチ総数: ${allBranches.length}`)

            const { branchesToDelete, patternStats } = await filterDeletableBranches(allBranches)

            console.log(`削除対象ブランチ総数: ${branchesToDelete.length}`)

            const branchesToDeleteNow = branchesToDelete.slice(0, MAX_DELETIONS)
            const remainingBranches = branchesToDelete.length - branchesToDeleteNow.length

            console.log(`今回削除予定: ${branchesToDeleteNow.length} ブランチ`)
            if (remainingBranches > 0) {
              console.log(`残り ${remainingBranches} ブランチは次回実行時に削除されます`)
            }

            if (branchesToDeleteNow.length > 0) {
              if (DRY_RUN) {
                for (const branch of branchesToDeleteNow) {
                  console.log(` [DRY-RUN] 削除対象: ${branch.name} (${branch.daysSince}日前)`)
                }
              } else {
                const branchNames = branchesToDeleteNow.map(branch => branch.name).join(' ')
                
                try {
                  execSync(`git push origin --delete ${branchNames}`, { 
                    cwd: process.cwd(),
                    stdio: 'pipe',
                    encoding: 'utf8'
                  })
                  
                  console.log('✅ すべてのブランチの削除が完了しました')
                  
                  for (const branch of branchesToDeleteNow) {
                    const logEntry = `✅ 削除完了: ${branch.name} (${branch.daysSince}日前)`
                    writeLog(logEntry)
                    console.log(logEntry)
                  }
                } catch (gitError) {
                  console.error(`❌ git push --delete でエラーが発生しました: ${gitError.message}`)
                }
              }
            }

            console.log('概要:')
            for (const [pattern, count] of Object.entries(patternStats)) {
              console.log(`- ${pattern.padEnd(10)}: ${count} ブランチ`)
            }

            console.log(`概要: ✅ 削除=${branchesToDeleteNow.length}、⏩ スキップ=${allBranches.length - branchesToDeleteNow.length}`)

      - name: Commit log file to repository
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .github/logs/deleted-branches.log
          if git diff --staged --quiet; then
            echo "変更はありません。コミットをスキップします。"
          else
            git commit -m "chore(github action log): 削除されたブランチのログを追加 - $(date '+%Y-%m-%d %H:%M:%S')"
            git push
          fi

      - name: Upload log file as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: deleted-branches-logs
          path: .github/logs/deleted-branches.log
          retention-days: 30
